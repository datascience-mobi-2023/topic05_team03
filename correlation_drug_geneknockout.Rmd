Gelerntes
na.rm überspringt nur die werte, es löscht sie nicht 



```{r}

#(((((((((((((((((((((((((((((((((((#this chuck contains code that wont be used

#zuerst die ccls ordnen, sodass bei prism und bei prism.achilles die gleiche reihenfolge der CCLs ist
#versuchen zuerst die correlation herauszufinden und dann die nas rausnehmen 
#die schnittmenge zwischen. prsim und achilles (350 geimeinsame gene )
#schleife, sodasss alle medikamente einmal druchgeangen werden
i=1
for (i in 1:dim(prism[2])) 
  (prism[,i])#durch alle meds iterieren

#fist remove all NAs
  i.remove = which(is.na(prism[,i]))
  i.new.prism = prism[-i.remove,i]
  #i.new.prism

#schleife, sodasss alle knockouts pro med durchgegangen werden 
  
  for (g in 1:dim(prism.achilles)[2])
  
    (prism.achilles[,g])#alle knockouts for 
    #die ccls raushauen, die NA haben (datacleaning)
    g.remove = which(is.na(prism[,g]))
    new.prism = prism[-g.remove,g]
    g.new.prism
    #correlation berechnen
    cor(i.new.prism,g.new.prism, method = "spearman")
    g = g+1
    
  i = i + 1
    
    
# noich ein mechanismus nötig, der bei beiden spaltren die ccls removed
# ein ende finden für g und i
```

```{r}
#lets try it with apply

#first the order of the CCls of prism is matched with the order of prism.achilles
copy_prism = prism

order_actual_prism=rownames(copy_prism)
order_target_prism = rownames(prism.achilles)
new_prism= copy_prism[match(order_target_prism, order_target_prism),]
#new_prism

cor_drug_gene <- apply(new_prism[,1:3], 2, function(x){ #first loop iterates through all columns of prism
  
   apply(prism.achilles[,1:5], 2, function(y){#second loop iterates through all columns of prsim.achilles for each gene
      #fist remove all NAs
    x.remove = which(is.na(x)) #detecting the postitions of the drugs scores with missing values
    y.remove = which(is.na(y))#detecting the postitions of the gene knockout scores with missing values
    y.new.prism = y[c(-y.remove, -x.remove)] #vector with CCls removed that had NA eitherr in y or x
    x.new.prism = x[c(-y.remove, -x.remove)]#vector with CCls removed that had NA eitherr in y or x
  cor(x.new.prism,y.new.prism, method = "spearman")
  #plot(x.new.prism, y.new.prism)
   }
   )
}
)
cor_drug_gene

# 
```


```{r}
#reducing the dataset achilles by filtering the high variance genes

#achilles.var = apply(prism.achilles, 2, var, na.rm = TRUE)
#quantile(achilles.var, c(0.4,0.5,0.6), na.rm = TRUE)
#hist(achilles.var)
#q95 = quantile(achilles.var, 0.95, na.rm = TRUE)
#names_highvar_genes = colnames(prism.achilles[which(achilles.var>q95)])
#achilles.highvar = prism.achilles[,names_highvar_genes]

#highvar <- function(dataframe, qx){
 # dataframe.var = apply(dataframe, 2, var, na.rm = TRUE)
 # quan = quantile(dataframe, probs =  qx, na.rm = TRUE)
#  names_highvar = colnames(dataframe)[which(dataframe.var>quan)]
 # dataframe[,names_highvar]
}

#dim(highvar(prism.exp, 0.9))
```


```{r}
#DEFINING a function that filters columns of a dataframe by variance 
dataframe=prism.exp
qx = 0.9
 highvar <- function(dataframe, qx){ dataframe.var = apply(dataframe, 2, var, na.rm = TRUE)
  quan = quantile(dataframe.var, probs =  qx, na.rm = TRUE)
  names_highvar = colnames(dataframe)[which(dataframe.var>quan)]
  dataframe[,names_highvar]
}

dim(highvar(prism.exp, 0.8))
```


```{r}
#trying to make a more general code so i dont have to code everything separately

#first the order of the CCls of prism is matched with the order of prism.achilles
dataset1 = prism.achilles
dataset2 = prism

correlation <- function(dataset1, dataset2){

copy_dataset1 = dataset1

order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]
#new_prism


cor_dataset1_dataset2 <- apply(new_dataset1, 2, function(x){ #first loop iterates through all columns of prism
  
   apply(dataset2, 2, function(y){#second loop iterates through all columns of prsim.achilles for each gene
      #fist remove all NAs
    x.remove = which(is.na(x)) #detecting the postitions of the drugs scores with missing values
    y.remove = which(is.na(y))#detecting the postitions of the gene knockout scores with missing values
    y_cleaned = y[c(-y.remove, -x.remove)] #vector with CCls removed that had NA eitherr in y or x
    x_cleaned = x[c(-y.remove, -x.remove)]#vector with CCls removed that had NA eitherr in y or x
  cor(x_cleaned,y_cleaned, method = "spearman")
  
   }
   )
}
)
}
cor_dataset1_dataset2
```



```{r}
#!!!!!!!! key correlation matrix betwen all genekockouts and prism scores
prism.achilles.highvar = highvar(prism.achilles, 0.9)
prism.highvar = highvar(prism, 0.9)
cor_drugs_genes = correlation(prism.highvar, prism.achilles.highvar)
cor_drugs_genes
```


+++++++++++++correlations+betweeen+preselected+prism+and+expression++cnv+++++++++++++++++++++++

```{r}

#HERE THE THRESHOLD OF CORRELTAION MATRIX IS SET 
H = 0.15
correlations_above_threshold <- apply(cor_drugs_genes, 2, function(x){
  sum(x> H)
})

#correlations_above_threshold
#morethannull = correlations_above_threshold[isTRUE(correlations_above_threshold>0)]
#morethannullcorrelations_above_threshold
correlations_above_threshold
sum(correlations_above_threshold>0)
which(correlations_above_threshold>0)
sum(cor_drugs_genes>H)
highly_correlated_drugs = correlations_above_threshold[which(correlations_above_threshold>0)]
highly_correlated_drugs

#hist(correlations_above_threshold, breaks = 400, xlim = range(c(0.5:5)), )

```


```{r}
#!!!!!!!!!!!!!! this code works!!!!!!! FOR LOOP DOES NOT WORK YET, LETS TRY IT WITH APPLY  AND THE COMPRIMIZED DATASET DDDDDDDDD

#high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] # reducing dimensionality of data to only drugs that had a high correlation


correlation_highcor <- function(data, pre_data2){
copy_data = data[, highly_correlated_drugs]
actual_data = rownames(data)
target_data = rownames(data2)
data_matched = copy_data[match(actual_data, target_data),]
same_rownames = rownames(data[which(rownames(data) %in% rownames(data2)),])
data_organized = data_matched[same_rownames,]
data2 = pre_data2[same_rownames,]




apply(data_organized,2, function(i){
     # i=data_organized[,correlation_matrix[p]]
      apply(data2 ,2,function(k){#iterating through prism.exp
        #i=data_organized[,n]
        i_remove = which(is.na(i))
        k_remove = which(is.na(k))
        cleaned_i = i[c(-i_remove, -k_remove)]
        cleaned_k = k[c(-k_remove, -i_remove)]
        cor(cleaned_i, cleaned_k, method = "spearman")
       # print(correlation_data_data2)
        })
}#closes if 
)
}#closes fun
```



```{r}
#calculating the correlations between preselected prism and prismexp
prism.exp.0.9 = highvar(prism.exp, 0.9)
highcor_prism_exp = correlation_highcor(prism, prism.exp.0.9)
dim(highcor_prism_exp)

```

```{r}
#SOME DESCRIPTIVE STATISITCS ON THE CORREALTIONS BETWEEN PRISM.EXP AND PRISM
q90prism = quantile(highcor_prism_exp, probs = 0.9)

a = rownames(highcor_prism_exp)
b = colnames(highcor_prism_exp)
for (m in 1:dim(highcor_prism_exp)[1]){
  for(n in 1:dim(highcor_prism_exp)[2]){
    if(highcor_prism_exp[m,n] > q90prism){
      ah = a[m]
      bh = b[n]
      ch = highcor_prism_exp[m,n]
      print(paste(ah, "coorelates with", bh, "->", ch))
    }
  }
}
```



```{r}
#FINDING CORRELATIONS BETWEEN IMPORTANT DRUGS AND CNV EEEEEEEEE

#high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] # reducing dimensionality of data to only drugs that had a high correlation
high_cor_drugs_cnv <- correlation_highcor(prism, highvar(prism.cnv, 0.9))

```




+++++++++++++++++++GENE_KNOCKOUT_CORRELATIONS+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


```{r}
#EXTRACTING THE GENE knockouts WITH HIGH CORRELATIONS 
correlations_above_threshold_geneknockout <- apply(cor_drugs_genes, 1, function(x){
  sum(x>0.15)
})

#correlations_above_threshold
#morethannull = correlations_above_threshold[isTRUE(correlations_above_threshold>0)]
#morethannullcorrelations_above_threshold

sum(correlations_above_threshold_geneknockout>0)
which(correlations_above_threshold_geneknockout>0)
sum(cor_drugs_genes>0.15)
highly_correlated_geneknockouts = correlations_above_threshold_geneknockout[which(correlations_above_threshold_geneknockout>0)]
highly_correlated_geneknockouts
names_correlations_above_threshold_geneknockout = names(which(correlations_above_threshold_geneknockout>0))
names_correlations_above_threshold_geneknockout

#hist(correlations_above_threshold, breaks = 400, xlim = range(c(0.5:5)), )

```


```{r}
#CALCULATING CORRELATIONS BETWEEN FOR HIGH CORRELATION PRSELECTED PRISM.ACHILLES AND GENE EXPRESSION
correlation_highcor_ACHILLES <- function(data, pre_data2){
copy_data = data[,names_correlations_above_threshold_geneknockout]
actual_data = rownames(data)
target_data = rownames(data2)
data_matched = copy_data[match(actual_data, target_data),]
same_rownames = rownames(data[which(rownames(data) %in% rownames(data2)),])
data_organized = data_matched[same_rownames,]
data2 = pre_data2[same_rownames,]




apply(data_organized,2, function(i){
     # i=data_organized[,correlation_matrix[p]]
      apply(data2 ,2,function(k){#iterating through prism.exp
        #i=data_organized[,n]
        i_remove = which(is.na(i))
        k_remove = which(is.na(k))
        cleaned_i = i[c(-i_remove, -k_remove)]
        cleaned_k = k[c(-k_remove, -i_remove)]
        cor(cleaned_i, cleaned_k, method = "spearman")
       # print(correlation_data_data2)
        })
}#closes if 
)
}#closes fun
```



```{r}
#FINDING CORRELATIONS BETWEEN GENE KNOCKOUTS AND EXPRESSION
high_cor_genknockout_exp = correlation_highcor_ACHILLES(prism.achilles, highvar(prism.exp, 0.9))
```

```{r}
#FINDING CORRELATIONS B
high_cor_genknockout_cnv = correlation_highcor(prism.achilles, highvar(prism.cnv, 0.9))
```

```{r}
#ARE THERE ANY DRUG/GENE PAIRS THAT BOTH HAVE HIGH CORREALTIONS WITH the same BIOMARKER?
which(rown)

```



```{r}
# CODE OPTIMIZATION
data2 = prism.exp

apply(data2 ,2,function(k){#iterating through prism.exp
        
        i=prism[1:length(k),200]
        i_remove = which(is.na(i))
        k_remove = which(is.na(k))
        cleaned_i = i[c(-i_remove, -k_remove)]
        cleaned_k = k[c(-k_remove, -i_remove)]
        correlation_data_data2 <- cor(cleaned_i, cleaned_k, method = "spearman")
    
})
```


```{r}
#CODEPOTIMIERUNG
correlation_matrix = cor_drugs_genes
for (m in (1:dim(correlation_matrix)[1])){
  for (n in (1:dim(correlation_matrix)[2])){
    if(correlation_matrix[m,n] > 0.4){
      f = rownames(correlation_matrix)
      g = colnames(correlation_matrix)
      i = f[m]
      j = f[n]
      print(j)
    }
  }}
```


```{r}
#AUTOMATISIERUNG
#lets find some biomarkers, that are linked with drug sensitivity of CCLs 

# first we want to extract the drug gene pairs that are highly correlated 

T = 0.8 #setting a threshold

copy_prism
actual_prism = rownames(prism)
target_prism = rownames(prism.exp)
treatment_prism = copy_prism[match(actual_prism, target_prism),]
cor_matrix = cor_drugs_genes


apply(cor_matrix, function(p){ #p is one correlation value
 
   if (p > T)#filtering correlations below threshold
    treatment = colname(p) 
    i=treatment_prism[,treatment] # extracting the column with the IC50 values of the drug of one of the drug gene pairs in prism
    apply(prism.exp,2,function(k){#iterating through prism.exp
      i_remove = which(is.na(i))#removing NAs from the prsim column, prism.exp doesnt have any NA
      cleaned_i = i[-i_remove]
      cleaned_k = k[-i_remove]
      cor(cleaned_i, cleaned_k, method = "spearman")
    }
    )
}
)
```




```{r}
#same point, but with gene fitness
#lets find some biomarkers, that are linked with gene fitness of ccls
#CCLs are the same in cnv and prism
# first we want to extract the drug gene pairs that are highly correlated 

T = 0.8 #setting a threshold

rm <- which(rownames(prism.achilles) %in% rownames(prism.exp))
prism_achilles_congruent = prism.achilles[rm,] #selceting the ccl in achilles screen that also exist in prism.cnv

copy_prism.exp = copy(prism.exp)
actual_prism.exp = rownames(prism.exp)
target_prism.exp = rownames(prism_achilles_congruent)
prism.achilles_clean = copy_prism.exp[match(actual_prism.cnv, target_prism.cnv),]

apply(cor_drug_gene, function(p){ #p is one correlation value
 
   if (p > T)#filtering correlations below threshold
    gene_knockout = colname(p) 
    w=prism.achilles_clean[,gene_knockout] # extracting the column with the IC50 values of the drug of one of the drug gene pairs in prism
    apply(prism.exp,2,function(k){#iterating through prism.exp
    w.remove = which(is.na(w))
    w_clean = w[-w.remove]
    k_clean = k[-w.remove] 
      cor(w_clean, k_clean, method = "spearman")
    }
    )
}
)
```

```{r}
#CORRELATION DRUG SENSITIVITY/ CNV

copy_prism.cnv = copy(prism.cnv)
actual_prism.cnv = rownames(prism.cnv)
target_prism.cnv = rownames(prism_achilles_congruent)
prism.achilles_clean = copy_prism.cnv[match(actual_prism.cnv, target_prism.cnv),]
```


```{r}
#so wir wollen testen, ob das überhaupt lappt SIIUUUUU
v1 <- c(1,2,3,4,5,6,7)
remove.d = which(v1 == 2)
reomove.t = which(v1 == 3)
v2 = v1[-remove.d]
v2
v3 = v1[c(-remove.d, -reomove.t)]
v3
```


```{r}
#data ordnen: die ordung der zeilen von prsim.achilles wird an die ordnung der zeilen von prism angepasst

#copy_achilles= prism.achilles

#order_actual_achilles= rownames(copy_achilles)
#order_target_achilles = rownames(prism)
#new_prsim.achilles= copy_achilles[match(order_target_achilles, order_actual_achilles),]
#new_prsim.achilles
```
```{r}
#data ordnen: die ordung der zeilen von prsim wird an die ordnung der zeilen von prism. achilles angepasst


copy_prism = prism

order_actual_prism=rownames(copy_prism)
order_target_prism = rownames(prism.achilles)
new_prism= copy_prism[match(order_target_prism, order_target_prism),]
new_prism
```


+++++COMPARING THE HIGHLY CORRELATED DRUG/GENE PAIRS WITH THE LIVER CANCER DRUG TARGETS+++++++++++++++++++++++++++++++++++++++++++++++++++

```{r}
liver_cancer_indices = which(prism.cl$disease == "Liver Cancer")
liver_cancer_cellline_names = prism.cl$DepMap_ID[liver_cancer_indices]
liver_cancer_cell_lines_scores = prism[liver_cancer_cellline_names,]
show(liver_cancer_cell_lines_scores)
```

```{r}
#lets see if the highly corelated drug/genes target liver cancer genes


threshold2 = -0.6
livercancer_mean_drug_score = apply(liver_cancer_cell_lines_scores, 2, mean, na.rm=TRUE)
names_important_drugs_liver_cancer = names(livercancer_mean_drug_score)[which((livercancer_mean_drug_score)< threshold2)] #zuerst wird der mean von allen cell line scores berechnet, dann werden die drugs ausgewählt, die eine durchschnittliche drug sensitivity von über threshold haben. von den 
important_drugs_livercancer.treat = prism.treat[names_important_drugs_liver_cancer,]
#show(important_drugs_livercancer.treat)
Liver_cancer_target_genes = unique(important_drugs_livercancer.treat$target)
Liver_cancer_target_genes_all = important_drugs_livercancer.treat$target



```

```{r}

```


```{r}
table(Liver_cancer_target_genes)
#problem = die targets werden als ein bestimmtes target gesehen, wenn es mehrere targets gibt, und nicht als einzelne targets 
```

```{r}
#WICH DRUGS OF THE DRUG/GENE PAIRS DO HAVE THE SAME TARGETS AS THE IMPORTANT LIVER GENES----THIS STEP IS PRETTY UNNECESSARY AS IT CAN BE FOUND OUT IN A MUCH EASIER WAY!!
names_highly_correlated_drugs = names(highly_correlated_drugs)
prism.treat_highly_correlated_drugs_targets = prism.treat[names_highly_correlated_drugs,]$target
length(prism.treat_highly_correlated_drugs_targets)


same_targetsB = which(Liver_cancer_target_genes %in% prism.treat_highly_correlated_drugs) 
#same_targetsB = which(prism.treat_highly_correlated_drugs_targets %in% Liver_cancer_target_genes) 
length(same_targetsB)
#same_targetsB
Liver_cancer_target_genes[same_targetsB]


```

```{r}
#finding genes of the drug/gene pairs that are the same as liver cnacer target genes 
same_targetsA = which(names_correlations_above_threshold_geneknockout%in%Liver_cancer_target_genes)
#same_targetsB = which(Liver_cancer_target_genes%in%names_correlations_above_threshold_geneknockout)#second object is the genes that correlate with a drug above a threshold
length(same_targetsA)
#length(same_targetsB)
same_targetsA
#same_targetsB
names_liver_cancer_target_genes_highcorA = names_correlations_above_threshold_geneknockout[same_targetsA]
#names_liver_cancer_target_genes_highcorB = Liver_cancer_target_genes[same_targetsB]
names_liver_cancer_target_genes_highcorA
#names_liver_cancer_target_genes_highcorB
#!!!!!!ALL THEM GENES HAVE AT LEAST ONE PAIRED DRUG THAT MAY HAVE OTHER TARGETS BUT STILL HAVE THE SAME EFFECT--> FIND THEM 
#indices_liver_cancer_targets = which(rownames(cor_drugs_genes) %in% names_liver_cancer_target_genes_highcor)
#indices_liver_cancer_targets
#machs dirket mit den names
cor_drugs_genes_lctargetgenes = cor_drugs_genes[names_liver_cancer_target_genes_highcorA,] #correlation matrix only with important liver genes 
```

```{r}
 #threshold
highcor_filter <- function(threshold3, matrix){apply(cor_drugs_genes_lctargetgenes, 1, function(x){
  drugs_with_highcor = which(x > threshold3)
  x[drugs_with_highcor]
})}
```

```{r}
#FOUND THE DRUGS THAT CORRELATE WITH THE GENE KNOCKOUTS THAT ARE EFFICIENT FOR LIVER CANCER TREATMENT 
drug_gene_pairs_lc = highcor_filter(0.15, cor_drugs_genes_lctargetgenes)
vector_drug_gene_pairs_lc = unlist(drug_gene_pairs_lc)
vector_drug_gene_pairs_lc
table(vector_drug_gene_pairs_lc)
```


```{r}
#for the next step: We wanna find the drugs that have high cor
K = 0.15

drugs_with_high = apply(cor_drugs_genes_lctargetgenes, 2, function(y){
  length(which(y>K))
}
)
vector_drugsof_drug_gene_pairs_lc = names(which(drugs_with_high>0))
```



```{r}
#BUT!!! ARE THERE ANY NEW DRUGS THAT DID NOT SHOW to be EFFECTIVE as a TREATMENT IN PRISM???
#first lets find o


indices_same_drugs = which(vector_drugsof_drug_gene_pairs_lc %in% names_important_drugs_liver_cancer)
length(vector_drugsof_drug_gene_pairs_lc)
length(indices_same_drugs)
unexpected_drugs_lc = vector_drugsof_drug_gene_pairs_lc[-indices_same_drugs]
unexpected_drugs_lc

#look at the prism scores foer all cancer cell lines 



```

```{r}
#LETS HAVE A LOOK AT THE PRISM SCORES OF THE UNEXPECTED DRUGS 
prims_liver_cancer_unexpected_drugs = prism[liver_cancer_cellline_names, unexpected_drugs_lc]
prims_liver_cancer_unexpected_drugs

```






+++++++++++LOOKING FOR BIOMARKERS THAT HAVE HIGH CORRELATION BOTH WITH DRUG SENSITIVITY AND GENE KNOCKOUT+++++++++++++++++++++++++++++++++

```{r}
#IN THIS CHUNK, WE FIND THE DRUGS AND GENES THAT HAVE HIGH CORRELATIONS WITH THE SAME BIOMARKER 
#STEPS THAT NEED TO BE DONE:
#1 für jedes drug die hohen expressionscorrelationen rausfischen 
#2 für jeden gene knockout die hohen korrelationen rausfischen
#3 vergleichen, ob übereinsgtimmungen zu finden sind 
#falls ja, soll das ausgegeben wereden 
#das alles soll für jeden exp durchgemacht werden 

C = 0.15 #threshold for correlation of drug or genewith exp
result_list <- lapply(rownames(highcor_prism_exp), function(x){
  a = which(highcor_prism_exp[x,] > C)
  a2 = colnames(highcor_prism_exp)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
  return(list(Biomarker = x, correlatingDrug = a2,correlatingGeneknockout = b2))

})
result_list
```

```{r}
result_list[[c(1,3)]]
```



```{r}
###############################
C = 0.15 #threshold for correlation of drug or genewith exp
result_list <- lapply(rownames(highcor_prism_exp), function(x){
  a = which(highcor_prism_exp[x,] > C)

  a2 = colnames(highcor_prism_exp)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
 # return(list(Biomarker = x, correlatingDrug = a2,correlatingGeneknockout = b2))
  biomarker = x
  correlatingDrug = a2
  correlatingGeneknockout = b2
  return(c(biomarker, correlatingDrug, correlatingGeneknockout))


})
#return(list(biomarker, correlatingDrug, correlatingGeneknockout))
#result_list
liste <- list(biomarker, correlatingDrug, correlatingGeneknockout)
```
```{r}
############################doesnt work
C = 0.15 #threshold for correlation of drug or genewith exp
lelel= list()
result_list <- lapply(rownames(highcor_prism_exp), function(x){
  a = which(highcor_prism_exp[x,] > C)
  a2 = colnames(highcor_prism_exp)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
  if(length(b2) > 0 & length(a2)){
  result_list2 <- list(correlatingDrug = a2,correlatingGeneknockout = b2)
  biomarker_correlations[[x]] <- result_list2
  

})
```

```{r}
C = 0.15 #threshold for correlation of drug or genewith exp

biomarker_correlations <- list()
for (x in 1:length(rownames(highcor_prism_exp))){
  x = rownames(highcor_prism_exp)[x]
  a = which(highcor_prism_exp[x,] > C)
  a2 = colnames(highcor_prism_exp)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
  if(length(b2) > 0 & length(a2)){
  result_list2 <- list(correlatingDrug = a2,correlatingGeneknockout = b2)
  biomarker_correlations[[x]] <- result_list2
  }
}
biomarker_correlations
```

```{r}
#z = biomarkers_with_highcor[5]
#z
#biomarker_correlations$"ITGA3"
biomarker_correlations[[5]]
```


```{r}
#these are the biomarkers that have correlations both with drugs and gene knockouts
biomarkers_with_highcor = names(biomarker_correlations)
```

```{r}
##################################find the drug/gene pairs  does not work !!!!!!!!!!!!
Ä = 0.15 #threshold
#df_drug_gene_pairs = data.frame(matrix(ncol = 2, nrow = 0))  
#colnames(df_drug_gene_pairs) <- c("drug", "gene_knockout")
druggens = apply(cor_drugs_genes,c(1,2), function(x){
 if(x > Ä){
   p = colnames(x)
   j = rownames(x)
   drug_gene_pair = c(p,j)
 }
})
druggens
```

```{r}
#>>>>><<<<<<####not sure if it  works with the apply function

#find the drug/gene pairs 
Ä = 0.3 #threshold
df_drug_gene_pairs = data.frame(matrix(ncol = 0, nrow = 3))  
rownames(df_drug_gene_pairs) <- c("drug", "gene_knockout", "correlation value")
for (x in 1:dim(cor_drugs_genes)[1]){
  for (y in 1:dim(cor_drugs_genes)[2]){
     if(cor_drugs_genes[x,y] > Ä){
      p = rownames(cor_drugs_genes)[x]
      j = colnames(cor_drugs_genes)[y]
      k = cor_drugs_genes[x,y]
     # f = prism.treat$moa[p]
      drug_gene_pair = c(j,p,k)
      df_drug_gene_pairs[,ncol(df_drug_gene_pairs) + 1] <- drug_gene_pair
 }
}
}

df_drug_gene_pairs
```

```{r}
highcor_drugs = df_drug_gene_pairs[1,]
highcor_drugs_vector <- unlist(as.vector(highcor_drugs))
highcor_drugs_vector_unique <- unique(highcor_drugs_vector)
length(highcor_drugs_vector_unique)

#lets see their moa
prism.treat[highcor_drugs_vector, "moa"]
```

```{r}
#HDAC INHIBITORS SEEM TO BE HIGHLY CORRELATED TO MANY GENE KNOCKOUTS. LETS SEE IF THEY ARE OVEREXPRESSED IN LIVER CANCER.

vector_HDAC = c("HDAC1", "HDAC2", "HDAC3", "HDAC4", "HDAC5", "HDAC6", "HDAC7", "HDAC8", "HDAC9", "HDAC10", "HDAC11")

mean_HDAC_expression = apply(prism.exp[, vector_HDAC],2, mean)
mean_HDAC_expression_lc = apply(prism.exp[liver_cancer_cellline_names, vector_HDAC],2,mean)
df_HDAC_expressions = data.frame(mean_HDAC_expression_lc, mean_HDAC_expression)
df_HDAC_expressions

#t test poosible. do mean values significantly differ? 

```

```{r}
#lets see if there are genes that are highly correlated with the HDAC inhibitor, that are targets of effective liver cancer gene knockouts
highcor_gen = df_drug_gene_pairs[2,]
highcor_gen_vector <- unlist(as.vector(highcor_gen))
highcor_gen_vector_unique <- unique(highcor_gen_vector)
highcor_gen_vector_unique[which(highcor_gen_vector_unique %in% Liver_cancer_target_genes)]
length(which(highcor_gen_vector_unique %in% Liver_cancer_target_genes))
#these genes are all inhibited by HDAC inhibitors. they are likely to be closely associated in the protein network of liver cancer cells. 
```



```{r}
#FOR EACH BIOMARKER, WE HAVE TO SEE IF THERE ARE DRUG/GENE PAIRS IN THE HIGH CORREALTIONS 

#THIS IS WHY WE FIRST HAVE TO CREATE A LIST WITH THE DRUG/GENE PAIRS 
# this is done :)
#lapply(result_list, length)
#result_list
drugs_genes_biomarker <- data.frame(matrix(nrow = 3, ncol=0))
rownames(drugs_genes_biomarker) <- c("biomarker", "drug", "gene")
for (x in 1:length(biomarker_correlations)){
  
    biomarker_drugs_highcor = biomarker_correlations[[x]][1]
    biomarker_geneknockouts_highcor = biomarker_correlations[[x]][2]
    for (y in 1: ncol(df_drug_gene_pairs)){
    drug_ofdruggenepair = df_drug_gene_pairs[1,y]
    geneknockout_ofdruggenepair = df_drug_gene_pairs[2,y]
    
    same_drugs = which(biomarker_drugs_highcor %in% drug_ofdruggenepair)
    same_geneknockouts = which(biomarker_geneknockouts_highcor %in% geneknockout_ofdruggenepair)
    
    d = length(same_drugs)
    g = length(same_geneknockouts)
    
   
    
    if (d>0 & g>0){
      output = c(biomarkers_with_highcor[x], drug_ofdruggenepair, geneknockout_ofdruggenepair)
      drugs_genes_biomarker[,ncol(drugs_genes_biomarker)+1] <- output
    }
    
    
    
    
}
}

drugs_genes_biomarker


```


```{r}
drugs_genes_biomarker
```

##########################CLUSTERING########################

```{r}
library(cluster)
prism.0.9 = highvar(prism, 0.9)
prism.0.9.lc = prism.0.9

kmeans(na.omit(prism[,1:100]), centers = 3, nstart = 20)
```







```{r}
summary(highcor_prism_exp)
```





############cluster analysis#########################

WE WANT TO PERFORM A CLUSTER ANALYSIS

```{r}
install.packages("factoextra")
library(factoextra)
```


```{r}
#DATACLEANING
data_prism.achilles = na.omit(prism.achilles)
data_prism.exp = na.omit(prism.exp)
data_prism.cnv = na.omit(prism.cnv)
```

```{r}
data_lc <- data_prism.achilles[,Liver_cancer_target_genes]
data_lc_target_genes_prism.achilles_highvar = highvar(data_lc_target_genes_prism.achilles_highvar)
```


```{r}

data = highvar(data_prism.achilles, 0.95)
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
```

```{r}
km.out <- kmeans(data, centers = 4, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```
```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```
```{r}
lc_gene
```


+++++++++now with prism cnv ++++++++++++

```{r}

data = highvar(data_prism.cnv, 0.95)
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
```

```{r}
km.out <- kmeans(data, centers = 4, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```
```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```


+++++++++ kmeans EXP +++++++++++++++++++++++++++++


```{r}

data = highvar(data_prism.achilles, 0.95)
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
```

```{r}
km.out <- kmeans(data, centers = 4, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```
```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```
















ENTRY TEST AREA 51 - WHAT HAPPENS HERE STAYS HERE

```{r}
x = rownames(highcor_prism_exp)[5]
a = which(highcor_prism_exp[x,] > 0)
 # a2 = highcor_prism_exp[x, a]
  a2 = colnames(highcor_prism_exp)[a]
  a2
  x
  a
  highcor_prism_exp[x,]
  length(highcor_prism_exp[x,])
```

```{r}
#I WANT TO GET ALL THE DRUG GENE PAIRS IN A MATRIX 

list_druggenepairs <- apply(cor_drugs_genes,c(1,2),function(x){
  if(x > T){
    return(list(colnames(x), rownames(x)))
  }
})
list_druggenepairs
```





```{r}

#removing all cell lines with missung values for one specific row
#sum(is.na(prism[,1]))
i.remove = which(is.na(prism[,1]))
#i.remove
new.prism1 = prism[-i.remove,1]
new.prism1

#remove CCLs with missing value for every row 
i.remove = which(is.na(prism[,i]))
#i.remove
new.prism = prism[-i.remove,i]
new.prism

```


```{r}
pheatmap(cor_drugs_genes)
```


```{r}
x <- prism[,1]
y <- prism[,2]
#berechnen der correlation
cor(x,y, method = "spearman")
```
```{r}
#just checking if all CCls of the achilles dataset are represented in the prism dataset
matching.CLL = rownames(prism) %in% rownames(prism.achilles)
sum(matching.CLL)
```

```{r}
length(apply(prism, 1, mean))
```

```{r}
#test area
h1 = c(1,2,3,2,3,NA)
h2 = c(2,NA,2,4,3,5)
h3 = c(2,4,NA,3,5,4)
h4 = c(2,2,3,2,4,5)

H <- data.frame(h1,h2,h3,h4)
H

cor(H, method = "spearman")
```
```{r}
#just some tests

x= prism[,2]
y= prism[,80]


    x.remove = which(is.na(x))
    x.remove
    y.remove = which(is.na(y))
    y.remove
    
sum(is.na(x))
sum(is.na(y))
    y.new.prism = y[c(-y.remove, -x.remove)]#y is a vector of gene knockout scores without NAs for all CCLs
    y.new.prism
  x.new.prism = x[c(-y.remove, -x.remove)]
  x.new.prism
  cor(x.new.prism,y.new.prism, method = "spearman")
```


```{r}
```
```{r}
#testing if the "2" is reoved twice and NO IT IS NOT :)
v1 <- c(1,2,3,4,5,6,7,8,9,10)
rmv1 <- c(1,2)
rmv2 <- c(2,3)

v1[c(-rmv1, -rmv2)]
```
```{r}
#SPIELPLATZ
sum(rownames(prism.achilles) %in% rownames(prism.exp))
rm <- which(rownames(prism.achilles) %in% rownames(prism.exp))
rownames(prism.achilles[rm,])


```

```{r}
#SPIELPLATZ
sum(is.na(prism.cnv))
sum(rownames(prism.achilles) %in% rownames(prism.cnv))
sum(rownames(prism) %in% rownames(prism.cnv))

sum(rownames(prism.cnv) %in% rownames(prism.achilles))
sum(rownames(prism.cnv) %in% rownames(prism))
```

```{r}
prism.var = apply(prism, 2, var)
q90 = quantile(prism.var, probs = 0.9)
topvari = which(prism.var > q90)

```


```{r}
z = 1:3
remo = which(is.na(prism[z,]))
cleanedpri = prism[z,][-remo]
apply(cleanedpri,2, function(x){
  if(x>0.5){
    print(x)}})

```
```{r}
#i want to reduce the dimensionslaity of the correlaion matrix to those columns that contain high correlationvalues, i just need the names of columns(drugs) with high correlation 

#first create a vektor with the sum the vlues above a threshold

threshold.machine <- function(x){
  which
  
}


apply(cor_drugs_genes, 2, )
```



```{r}
fef = c(1,2,3,4,5,6,7,8,9)
fef2= c(1,2,3,4,5,6,7,8,9)
fef3= c(4,5,4,3,5,6,45,4,4)
fef4 = c(3,4,3,43,43,4,2,4,4)
fef5 = c(5,67,4,7,8,5,3,5,8)

feframe <- data.frame(fef, fef2, fef3, fef4, fef5)
fuf <- apply(feframe, 2, function(x){
  sum(x > 5)})
fuf
#hist(fuf, breaks = 30)
sum(fuf>3)
fef3>3

```

```{r}
#CODETESTING
high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] #hist(apply(prism.exp, 2, mean), breaks= 200)

```

```{r}
#code testing 
dim(highvar(prism.exp, 0.1))
```


```{r}
#JUST PLAYING 
A = c(1,2,3,4,5,6,7,8)
B = c(2,3)
C = c(4,5,3,4,5,4,43,4)
#G = which( A %in% B)
#G
#H = which(B %in% A)
#H
```

```{r}
testlist <- list(x1= list(A,fef3), x2 = B, x3 = C)
#testlist <- list(x1= A, x2 = B, x3 = C)

testlist
lapply(testlist, mean)
```



```{r}
lapply(fef, function(x){
  x+1
})
```
```{r}
#LEARNING ABOUT LISTS
Name = "learn"
mylul <- list(Name= Name, vector7 = A, dat7 = feframe)
#mylul
mylul[c(1,2)]

```

```{r}
# Daten einlesen





data <- na.omit(highvar(prism.exp, 0.9))
  #read.csv("prism")

# K-Means-Clustering durchführen
k <- 6  # Anzahl der Cluster
set.seed(123)  # Festlegen des Zufallssaat für Reproduzierbarkeit
kmeans_model <- kmeans(data, centers = k)

# Ergebnisse anzeigen
print(kmeans_model)

# Visualisierung der Cluster
library(ggplot2)
ggplot(data, aes(x = prism.exp$colnames(data)[1], y = prism.exp$colnames(data)[2] , color = as.factor(kmeans_model$cluster))) +
  geom_point() +
  labs(color = "Cluster") +
  theme_minimal()
```

