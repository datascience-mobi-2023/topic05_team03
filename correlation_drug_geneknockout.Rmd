Gelerntes
na.rm überspringt nur die werte, es löscht sie nicht 



```{r}

#(((((((((((((((((((((((((((((((((((#this chuck contains code that wont be used

#zuerst die ccls ordnen, sodass bei prism und bei prism.achilles die gleiche reihenfolge der CCLs ist
#versuchen zuerst die correlation herauszufinden und dann die nas rausnehmen 
#die schnittmenge zwischen. prsim und achilles (350 geimeinsame gene )
#schleife, sodasss alle medikamente einmal druchgeangen werden
i=1
for (i in 1:dim(prism[2])) 
  (prism[,i])#durch alle meds iterieren

#fist remove all NAs
  i.remove = which(is.na(prism[,i]))
  i.new.prism = prism[-i.remove,i]
  #i.new.prism

#schleife, sodasss alle knockouts pro med durchgegangen werden 
  
  for (g in 1:dim(prism.achilles)[2])
  
    (prism.achilles[,g])#alle knockouts for 
    #die ccls raushauen, die NA haben (datacleaning)
    g.remove = which(is.na(prism[,g]))
    new.prism = prism[-g.remove,g]
    g.new.prism
    #correlation berechnen
    cor(i.new.prism,g.new.prism, method = "spearman")
    g = g+1
    
  i = i + 1
    
    
# noich ein mechanismus nötig, der bei beiden spaltren die ccls removed
# ein ende finden für g und i
```

```{r}
#lets try it with apply

#first the order of the CCls of prism is matched with the order of prism.achilles
copy_prism = prism

order_actual_prism=rownames(copy_prism)
order_target_prism = rownames(prism.achilles)
new_prism= copy_prism[match(order_target_prism, order_target_prism),]
#new_prism

cor_drug_gene <- apply(new_prism[,1:3], 2, function(x){ #first loop iterates through all columns of prism
  
   apply(prism.achilles[,1:5], 2, function(y){#second loop iterates through all columns of prsim.achilles for each gene
      #fist remove all NAs
    x.remove = which(is.na(x)) #detecting the postitions of the drugs scores with missing values
    y.remove = which(is.na(y))#detecting the postitions of the gene knockout scores with missing values
    y.new.prism = y[c(-y.remove, -x.remove)] #vector with CCls removed that had NA eitherr in y or x
    x.new.prism = x[c(-y.remove, -x.remove)]#vector with CCls removed that had NA eitherr in y or x
  cor(x.new.prism,y.new.prism, method = "spearman")
  #plot(x.new.prism, y.new.prism)
   }
   )
}
)
cor_drug_gene

# 
```

```{r}
prism_mean = apply(prism, 2, mean, na.rm = TRUE)

best_concentrations_per_drug = c()

length(prism_mean)
for (i in 1:1396){
  col_start = (i-1)*8 +1
  col_end = i*8
  split = prism_mean[col_start:col_end]
  
  potent_drug = names(which(split == min(split)))
  #print(potent_drug)
 # best_concentrations_per_drug[i] <- potent_drug
  best_concentrations_per_drug[i] <- rbind(potent_drug, best_concentrations_per_drug)

}
best_concentrations_per_drug
```



```{r}
prism.bestofeachdrug = prism[, best_concentrations_per_drug]

```


```{r}
#reducing the dataset achilles by filtering the high variance genes

#achilles.var = apply(prism.achilles, 2, var, na.rm = TRUE)
#quantile(achilles.var, c(0.4,0.5,0.6), na.rm = TRUE)
#hist(achilles.var)
#q95 = quantile(achilles.var, 0.95, na.rm = TRUE)
#names_highvar_genes = colnames(prism.achilles[which(achilles.var>q95)])
#achilles.highvar = prism.achilles[,names_highvar_genes]

#highvar <- function(dataframe, qx){
 # dataframe.var = apply(dataframe, 2, var, na.rm = TRUE)
 # quan = quantile(dataframe, probs =  qx, na.rm = TRUE)
#  names_highvar = colnames(dataframe)[which(dataframe.var>quan)]
 # dataframe[,names_highvar]
}

#dim(highvar(prism.exp, 0.9))
```


```{r}
#DEFINING a function that filters columns of a dataframe by variance 
dataframe=prism.exp
qx = 0.9
 highvar <- function(dataframe, qx){ dataframe.var = apply(dataframe, 2, var, na.rm = TRUE)
  quan = quantile(dataframe.var, probs =  qx, na.rm = TRUE)
  names_highvar = colnames(dataframe)[which(dataframe.var>quan)]
  dataframe[,names_highvar]
}

dim(highvar(prism.exp, 0.8))
```


```{r}
#trying to make a more general code so i dont have to code everything separately

#first the order of the CCls of prism is matched with the order of prism.achilles
dataset1 = prism.achilles
dataset2 = prism

correlation <- function(dataset1, dataset2){

copy_dataset1 = dataset1

order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_actual_dataset1),]
#new_prism


cor_dataset1_dataset2 <- apply(new_dataset1, 2, function(x){ #first loop iterates through all columns of prism
  
   apply(dataset2, 2, function(y){#second loop iterates through all columns of prsim.achilles for each gene
      #fist remove all NAs
    x.remove = which(is.na(x)) #detecting the postitions of the drugs scores with missing values
    y.remove = which(is.na(y))#detecting the postitions of the gene knockout scores with missing values
    y_cleaned = y[c(-y.remove, -x.remove)] #vector with CCls removed that had NA eitherr in y or x
    x_cleaned = x[c(-y.remove, -x.remove)]#vector with CCls removed that had NA eitherr in y or x
  cor(x_cleaned,y_cleaned, method = "spearman")
  
   }
   )
}
)
}
cor_dataset1_dataset2
```

```{r}
#calculating correlatios betweeen preselected prism and prism.exp
#cor_bestdrugs_exp = correlation(prism.bestofeachdrug, prism.exp)
```


```{r}
#!!!!!!!! key correlation matrix betwen all genekockouts and prism scores
prism.achilles.highvar = highvar(prism.achilles, 0.9)
prism.highvar = highvar(prism, 0.9)
cor_drugs_genes = correlation(prism.highvar, prism.achilles.highvar)
cor_drugs_genes
```

```{r}
#I want to see if the drug sensitivity cirrelated with the gene knockout seonsotovoty of the drugs target
cellline_names = rownames(prism)

correlations_drugtargets_genknockouts = data.frame(drug = "character", genknockout = "character", correlationvalue = "numeric")
#rownames(correlations_drugtargets_genknockouts) <- c("drug", "gen knockout", "correlation value")
copy_dataset1 = prism
dataset2 = prism.achilles
order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]

for (x in drug_targets_very_clean){
  y = rownames(prism.treat)[which(x == prism.treat$target)] #drug ausgewählt
  for (z in y){
  prism_scores = new_dataset1[,z]
  gene_knockout_fitness = dataset2[,x]
  
  prism.remove = which(is.na(prism_scores)) #detecting the postitions of the drugs scores with missing values
  gene_knockout.remove = which(is.na(gene_knockout_fitness))#detecting the postitions of the gene knockout scores with missing values
    prism_cleaned = prism_scores[c(-prism.remove, -gene_knockout.remove)] #vector with CCls removed that had NA eitherr in y or x
    gene_knockout_cleaned = gene_knockout_fitness[c(-prism.remove, -gene_knockout.remove)]#vector with CCls removed that had NA eitherr in y or x
  
  corel = cor(prism_cleaned, gene_knockout_cleaned, method = "spearman")
  output = c(z, x, corel)
  correlations_drugtargets_genknockouts <- rbind(correlations_drugtargets_genknockouts, output)
}
}
correlations_drugtargets_genknockouts

```

```{r}
#I want to see if the drug sensitivity cirrelated with the gene knockout seonsotovoty of the drugs target
cellline_names = rownames(prism)

correlations_drugtargets_genknockoutsB = data.frame(drug = "character", genknockout = "character", correlationvalue = "numeric")
#rownames(correlations_drugtargets_genknockouts) <- c("drug", "gen knockout", "correlation value")
copy_dataset1 = prism
dataset2 = prism.achilles
order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]

for (x in drug_targets_very_clean){
  y = rownames(prism.treat)[which(x %in% prism.treat$target)] #drug ausgewählt
  if(length(y) == 1){
  prism_scores = new_dataset1[,y]
  gene_knockout_fitness = dataset2[,x]
  
  prism.remove = which(is.na(prism_scores)) #detecting the postitions of the drugs scores with missing values
  gene_knockout.remove = which(is.na(gene_knockout_fitness))#detecting the postitions of the gene knockout scores with missing values
    prism_cleaned = prism_scores[c(-prism.remove, -gene_knockout.remove)] #vector with CCls removed that had NA eitherr in y or x
    gene_knockout_cleaned = gene_knockout_fitness[c(-prism.remove, -gene_knockout.remove)]#vector with CCls removed that had NA eitherr in y or x
  
  corel = cor(prism_cleaned, gene_knockout_cleaned, method = "spearman")
  output = c(y, x, corel)
  correlations_drugtargets_genknockoutsB <- rbind(correlations_drugtargets_genknockoutsB, output)
  }}
correlations_drugtargets_genknockoutsB
```

```{r}
#hist(correlations_drugtargets_genknockouts$correlationvalue)
length(correlations_drugtargets_genknockoutsB)
hist(as.numeric(correlations_drugtargets_genknockoutsB$correlationvalue[2:length(correlations_drugtargets_genknockoutsB$correlationvalue)]), breaks = 100, xlab ="correlations between drug sensitivity and gene knockout sensitivity of the drug´s target gene", main = "No high correlation between drug seonsitivity and gene fitness" )
```

```{r}
qqnorm(as.numeric(correlations_drugtargets_genknockoutsB$correlationvalue[2:length(correlations_drugtargets_genknockoutsB$correlationvalue)]), ylab= "Quantiles of Correaltions of Samples")
```



```{r}
summary(as.numeric(correlations_drugtargets_genknockoutsB$correlationvalue[2:length(correlations_drugtargets_genknockoutsB$correlationvalue)]
               ))
```

```{r}
correlations_drugtargets_genknockoutsB[which(correlations_drugtargets_genknockoutsB$correlationvalue >),]
```


```{r}
ded = unique(drug_targets_clean)
length(ded)
drug_targets_very_clean = ded[which(ded %in% colnames(prism.achilles))]



```
```{r}
#hist(correlations_drugtargets_genknockouts$correlationvalue)
length(correlations_drugtargets_genknockouts)
hist(as.numeric(correlations_drugtargets_genknockouts$correlationvalue[2:length(correlations_drugtargets_genknockouts$correlationvalue)]), breaks = 200)
```
```{r}
boxplot(as.numeric(correlations_drugtargets_genknockouts$correlationvalue[2:length(correlations_drugtargets_genknockouts$correlationvalue)]))
quantile(na.omit(as.numeric(correlations_drugtargets_genknockouts$correlationvalue[2:length(correlations_drugtargets_genknockouts$correlationvalue)])), 0.9)

```

```{r}
#I want to see if the drug sensitivity cirrelated with the gene knockout seonsotovoty of the drugs target
cellline_names = rownames(prism)

copy_dataset1 = dataset1

order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]

for (x in drug_targets_clean){
  y = rownames(prism.treat)[which(x == prism.treat$target)] #drug ausgewählt
  for (z in y){
  prism_scores = prism[,z]
  gene_knockout_fitness = prism.achilles[,x]
  cor.test(prism_scores, gene_knockout_fitness, method = "spearman")
}
}

```


```{r}
drug_targets <- c()

for (y in 1:nrow(prism.treat)) {
  targets = as.character(prism.treat[y, "target"]) #extract drug targets 
  # if drug has muliple taregts, they will be splitted
  if (grepl(",", targets)) {
    targets = strsplit(targets, ",")[[1]]
  }
  # Append targets to vector 
  drug_targets <- c(drug_targets, targets)
}
print(drug_targets)
drug_targets_clean = na.omit(drug_targets)
drug_targets_clean

```



```{r}
#I want to see if the drug sensitivity cirrelated with the gene expression of the drugs target
cellline_names = rownames(prism)

correlations_drugtargets_exp = data.frame(drug = "character", gene = "character", correlationvalue = "numeric")
#rownames(correlations_drugtargets_genknockouts) <- c("drug", "gen knockout", "correlation value")
copy_dataset1 = prism
dataset2 = prism.exp
order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]

for (x in drug_targets_very_clean){
  y = rownames(prism.treat)[which(x %in% prism.treat$target)] #drug ausgewählt
  if(length(y) == 1){
  prism_scores = new_dataset1[,y]
  gene_knockout_fitness = dataset2[,x]
  
  prism.remove = which(is.na(prism_scores)) #detecting the postitions of the drugs scores with missing values
  gene_knockout.remove = which(is.na(gene_knockout_fitness))#detecting the postitions of the gene knockout scores with missing values
    prism_cleaned = prism_scores[c(-prism.remove, -gene_knockout.remove)] #vector with CCls removed that had NA eitherr in y or x
    gene_knockout_cleaned = gene_knockout_fitness[c(-prism.remove, -gene_knockout.remove)]#vector with CCls removed that had NA eitherr in y or x
  
  corel = cor(prism_cleaned, gene_knockout_cleaned, method = "spearman")
  output = c(y, x, corel)
  correlations_drugtargets_exp<- rbind(correlations_drugtargets_exp, output)
  }}
correlations_drugtargets_exp
```
```{r}
length(correlations_drugtargets_genknockouts)
hist(as.numeric(correlations_drugtargets_exp$correlationvalue[2:length(correlations_drugtargets_exp$correlationvalue)]), breaks = 200)
```




+++++++++++++correlations+betweeen+preselected+prism+and+expression++cnv+++++++++++++++++++++++

```{r}

#HERE THE THRESHOLD OF CORRELTAION MATRIX IS SET 
H = 0.15
correlations_above_threshold <- apply(cor_drugs_genes, 2, function(x){
  sum(x> H)
})

#correlations_above_threshold
#morethannull = correlations_above_threshold[isTRUE(correlations_above_threshold>0)]
#morethannullcorrelations_above_threshold
correlations_above_threshold
sum(correlations_above_threshold>0)
which(correlations_above_threshold>0)
sum(cor_drugs_genes>H)
highly_correlated_drugs = correlations_above_threshold[which(correlations_above_threshold>0)]
highly_correlated_drugs

#hist(correlations_above_threshold, breaks = 400, xlim = range(c(0.5:5)), )

```


```{r}
#!!!!!!!!!!!!!! this code works!!!!!!! FOR LOOP DOES NOT WORK YET, LETS TRY IT WITH APPLY  AND THE COMPRIMIZED DATASET DDDDDDDDD

#high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] # reducing dimensionality of data to only drugs that had a high correlation


correlation_highcor <- function(data, pre_data2){
copy_data = data
actual_data = rownames(data)
target_data = rownames(pre_data2)
data_matched = copy_data[match(actual_data, target_data),]
same_rownames = rownames(data[which(rownames(data) %in% rownames(pre_data2)),])
data_organized = data_matched[same_rownames,]
data2 = pre_data2[same_rownames,]




apply(data_organized,2, function(i){
     # i=data_organized[,correlation_matrix[p]]
      apply(data2 ,2,function(k){#iterating through prism.exp
        #i=data_organized[,n]
        i_remove = which(is.na(i))
        k_remove = which(is.na(k))
        cleaned_i = i[c(-i_remove, -k_remove)]
        cleaned_k = k[c(-k_remove, -i_remove)]
        cor(cleaned_i, cleaned_k, method = "spearman")
       # print(correlation_data_data2)
        })
}#closes if 
)
}#closes fun
```

```{r}
#calculating the correlations between prism and prismexp
cor_highvarprism_highvarexp = correlation_highcor(prism, highvar(prism.achilles,0.9))
```

```{r}
cor_bestdrugs_exp = correlation_highcor(prism.bestofeachdrug, prism.achilles)
```


```{r}
cor_bestdrugs_expression = correlation(prism.bestofeachdrug, highvar(prism.exp, 0.9))
save(cor_bestdrugs_expression, file = "cor_bestdrugs_expression.RData")


```

```{r}
prism.exp.sdevnull = which(apply(prism.exp, 2, sd, na.rm= TRUE) == 0)
prism.exp.sdevnull
prism.exp[,-prism.exp.sdevnull]
```


```{r}
#calculating the correlations between preselected prism and prismexp
prism.exp.0.9 = highvar(prism.exp, 0.9)
highcor_prism_exp = correlation_highcor(prism[,highly_correlated_drugs], prism.exp.0.9)
dim(highcor_prism_exp)

```

```{r}
#SOME DESCRIPTIVE STATISITCS ON THE CORREALTIONS BETWEEN PRISM.EXP AND PRISM
q90prism = quantile(highcor_prism_exp, probs = 0.9)

a = rownames(highcor_prism_exp)
b = colnames(highcor_prism_exp)
for (m in 1:dim(highcor_prism_exp)[1]){
  for(n in 1:dim(highcor_prism_exp)[2]){
    if(highcor_prism_exp[m,n] > q90prism){
      ah = a[m]
      bh = b[n]
      ch = highcor_prism_exp[m,n]
      print(paste(ah, "coorelates with", bh, "->", ch))
    }
  }
}
```



```{r}
#FINDING CORRELATIONS BETWEEN IMPORTANT DRUGS AND CNV EEEEEEEEE

#high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] # reducing dimensionality of data to only drugs that had a high correlation
high_cor_drugs_cnv <- correlation_highcor(prism, highvar(prism.cnv, 0.9))

```




+++++++++++++++++++GENE_KNOCKOUT_CORRELATIONS+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


```{r}
#EXTRACTING THE GENE knockouts WITH HIGH CORRELATIONS 
correlations_above_threshold_geneknockout <- apply(cor_drugs_genes, 1, function(x){
  sum(x>0.15)
})

#correlations_above_threshold
#morethannull = correlations_above_threshold[isTRUE(correlations_above_threshold>0)]
#morethannullcorrelations_above_threshold

sum(correlations_above_threshold_geneknockout>0)
which(correlations_above_threshold_geneknockout>0)
sum(cor_drugs_genes>0.15)
highly_correlated_geneknockouts = correlations_above_threshold_geneknockout[which(correlations_above_threshold_geneknockout>0)]
highly_correlated_geneknockouts
names_correlations_above_threshold_geneknockout = names(which(correlations_above_threshold_geneknockout>0))
names_correlations_above_threshold_geneknockout

#hist(correlations_above_threshold, breaks = 400, xlim = range(c(0.5:5)), )

```


```{r}
#CALCULATING CORRELATIONS BETWEEN FOR HIGH CORRELATION PRSELECTED PRISM.ACHILLES AND GENE EXPRESSION
correlation_highcor_ACHILLES <- function(data, pre_data2){
copy_data = data
actual_data = rownames(data)
target_data = rownames(pre_data2)
data_matched = copy_data[match(actual_data, target_data),]
same_rownames = rownames(data[which(rownames(data) %in% rownames(pre_data2)),])
data_organized = data_matched[same_rownames,]
data2 = pre_data2[same_rownames,]




apply(data_organized,2, function(i){
     # i=data_organized[,correlation_matrix[p]]
      apply(data2 ,2,function(k){#iterating through prism.exp
        #i=data_organized[,n]
        i_remove = which(is.na(i))
        k_remove = which(is.na(k))
        cleaned_i = i[c(-i_remove, -k_remove)]
        cleaned_k = k[c(-k_remove, -i_remove)]
        cor(cleaned_i, cleaned_k, method = "spearman")
       # print(correlation_data_data2)
        })
}#closes if 
)
}#closes fun
```



```{r}
#FINDING CORRELATIONS BETWEEN GENE KNOCKOUTS AND EXPRESSION
high_cor_genknockout_exp = correlation_highcor_ACHILLES(highvar(prism.achilles, 0.9), highvar(prism.exp, 0.9)) #das zweite ist die zeile in der cormatrix
```

```{r}
achilles.mean = apply(prism.achilles, 2, mean, na.rm = TRUE)
q10_achilles.mean = quantile(achilles.mean, 0.1)
q10_achilles.mean
achilles_below_q10 = which(achilles.mean < q10_achilles.mean)
#boxplot(achilles.mean)
prism.achilles[,achilles_below_q10]
```


```{r}
#FINDING CORRELATIONS BETWEEN GENE KNOCKOUTS AND EXPRESSION
high_cor_genknockout_exp = correlation_highcor_ACHILLES(prism.achilles[,achilles_below_q10], highvar(prism.exp, 0.9)) #das zweite ist die zeile in der cormatrix
save(high_cor_genknockout_exp, file = "high_cor_genknockout_exp.RData")
```


```{r}
#FINDING CORRELATIONS B
high_cor_genknockout_cnv = correlation_highcor(prism.achilles, highvar(prism.cnv, 0.9))
```

```{r}
#ARE THERE ANY DRUG/GENE PAIRS THAT BOTH HAVE HIGH CORREALTIONS WITH the same BIOMARKER?
which(rown)

```





```{r}
#XXXXAUTOMATISIERUNG
#lets find some biomarkers, that are linked with drug sensitivity of CCLs 

# first we want to extract the drug gene pairs that are highly correlated 

T = 0.8 #setting a threshold

copy_prism = prism
actual_prism = rownames(prism)
target_prism = rownames(prism.exp)
treatment_prism = copy_prism[match(actual_prism, target_prism),]
cor_matrix = cor_drugs_genes


apply(cor_matrix, function(p){ #p is one correlation value
 
   if (p > T)#filtering correlations below threshold
    treatment = colname(p) 
    i=treatment_prism[,treatment] # extracting the column with the IC50 values of the drug of one of the drug gene pairs in prism
    apply(prism.exp,2,function(k){#iterating through prism.exp
      i_remove = which(is.na(i))#removing NAs from the prsim column, prism.exp doesnt have any NA
      cleaned_i = i[-i_remove]
      cleaned_k = k[-i_remove]
      cor(cleaned_i, cleaned_k, method = "spearman")
    }
    )
}
)
```




```{r}
#same point, but with gene fitness
#lets find some biomarkers, that are linked with gene fitness of ccls
#CCLs are the same in cnv and prism
# first we want to extract the drug gene pairs that are highly correlated 

T = 0.8 #setting a threshold

rm <- which(rownames(prism.achilles) %in% rownames(prism.exp))
prism_achilles_congruent = prism.achilles[rm,] #selceting the ccl in achilles screen that also exist in prism.cnv

copy_prism.exp = copy(prism.exp)
actual_prism.exp = rownames(prism.exp)
target_prism.exp = rownames(prism_achilles_congruent)
prism.achilles_clean = copy_prism.exp[match(actual_prism.cnv, target_prism.cnv),]

apply(cor_drug_gene, function(p){ #p is one correlation value
 
   if (p > T)#filtering correlations below threshold
    gene_knockout = colname(p) 
    w=prism.achilles_clean[,gene_knockout] # extracting the column with the IC50 values of the drug of one of the drug gene pairs in prism
    apply(prism.exp,2,function(k){#iterating through prism.exp
    w.remove = which(is.na(w))
    w_clean = w[-w.remove]
    k_clean = k[-w.remove] 
      cor(w_clean, k_clean, method = "spearman")
    }
    )
}
)
```


```{r}
#so wir wollen testen, ob das überhaupt lappt SIIUUUUU
v1 <- c(1,2,3,4,5,6,7)
remove.d = which(v1 == 2)
reomove.t = which(v1 == 3)
v2 = v1[-remove.d]
v2
v3 = v1[c(-remove.d, -reomove.t)]
v3
```


```{r}
#data ordnen: die ordung der zeilen von prsim.achilles wird an die ordnung der zeilen von prism angepasst

#copy_achilles= prism.achilles

#order_actual_achilles= rownames(copy_achilles)
#order_target_achilles = rownames(prism)
#new_prsim.achilles= copy_achilles[match(order_target_achilles, order_actual_achilles),]
#new_prsim.achilles
```
```{r}
#data ordnen: die ordung der zeilen von prsim wird an die ordnung der zeilen von prism. achilles angepasst


copy_prism = prism

order_actual_prism=rownames(copy_prism)
order_target_prism = rownames(prism.achilles)
new_prism= copy_prism[match(order_target_prism, order_target_prism),]
new_prism
```


+++++COMPARING THE HIGHLY CORRELATED DRUG/GENE PAIRS WITH THE LIVER CANCER DRUG TARGETS+++++++++++++++++++++++++++++++++++++++++++++++++++

```{r}
liver_cancer_indices = which(prism.cl$disease == "Liver Cancer")
liver_cancer_cellline_names = prism.cl$DepMap_ID[liver_cancer_indices]
liver_cancer_cell_lines_scores = prism[liver_cancer_cellline_names,]
show(liver_cancer_cell_lines_scores)
```

```{r}
#lets see if the highly corelated drug/genes target liver cancer genes


threshold2 = -0.6
livercancer_mean_drug_score = apply(liver_cancer_cell_lines_scores, 2, mean, na.rm=TRUE)
names_important_drugs_liver_cancer = names(livercancer_mean_drug_score)[which((livercancer_mean_drug_score)< threshold2)] #zuerst wird der mean von allen cell line scores berechnet, dann werden die drugs ausgewählt, die eine durchschnittliche drug sensitivity von über threshold haben. von den 
important_drugs_livercancer.treat = prism.treat[names_important_drugs_liver_cancer,]
#show(important_drugs_livercancer.treat)
Liver_cancer_target_genes = unique(important_drugs_livercancer.treat$target)
Liver_cancer_target_genes_all = important_drugs_livercancer.treat$target



```


```{r}
table(Liver_cancer_target_genes)
#problem = die targets werden als ein bestimmtes target gesehen, wenn es mehrere targets gibt, und nicht als einzelne targets 
```

```{r}
#XXXXXXXXXWICH DRUGS OF THE DRUG/GENE PAIRS DO HAVE THE SAME TARGETS AS THE IMPORTANT LIVER GENES----THIS STEP IS PRETTY UNNECESSARY AS IT CAN BE FOUND OUT IN A MUCH EASIER WAY!!
names_highly_correlated_drugs = names(highly_correlated_drugs)
prism.treat_highly_correlated_drugs_targets = prism.treat[names_highly_correlated_drugs,]$target
length(prism.treat_highly_correlated_drugs_targets)
#we found the targets of the drugs, that have an effect on cell growth of liver cancer celllines 

same_targetsB = which(Liver_cancer_target_genes %in% prism.treat_highly_correlated_drugs) #looking for same targets of liver cancer teraget genes and targets of the drugs that inhibit lc celline growth effectively
length(same_targetsB)
#same_targetsB
Liver_cancer_target_genes[same_targetsB]


```

```{r}
#finding genes of the drug/gene pairs that are the same as liver cnacer target genes 
same_targetsA = which(names_correlations_above_threshold_geneknockout%in%Liver_cancer_target_genes)
#same_targetsB = which(Liver_cancer_target_genes%in%names_correlations_above_threshold_geneknockout)#second object is the genes that correlate with a drug above a threshold
length(same_targetsA)
#length(same_targetsB)
same_targetsA
#same_targetsB
names_liver_cancer_target_genes_highcorA = names_correlations_above_threshold_geneknockout[same_targetsA]
#names_liver_cancer_target_genes_highcorB = Liver_cancer_target_genes[same_targetsB]
names_liver_cancer_target_genes_highcorA
#names_liver_cancer_target_genes_highcorB
#!!!!!!ALL THEM GENES HAVE AT LEAST ONE PAIRED DRUG THAT MAY HAVE OTHER TARGETS BUT STILL HAVE THE SAME EFFECT--> FIND THEM 
#indices_liver_cancer_targets = which(rownames(cor_drugs_genes) %in% names_liver_cancer_target_genes_highcor)
#indices_liver_cancer_targets
#machs dirket mit den names
cor_drugs_genes_lctargetgenes = cor_drugs_genes[names_liver_cancer_target_genes_highcorA,] #correlation matrix only with important liver genes 
```

```{r}
 #threshold
highcor_filter <- function(threshold3, matrix){apply(cor_drugs_genes_lctargetgenes, 1, function(x){
  drugs_with_highcor = which(x > threshold3)
  x[drugs_with_highcor]
})}
```

```{r}
#FOUND THE DRUGS THAT CORRELATE WITH THE GENE KNOCKOUTS THAT ARE EFFICIENT FOR LIVER CANCER TREATMENT 
drug_gene_pairs_lc = highcor_filter(0.15, cor_drugs_genes_lctargetgenes)
vector_drug_gene_pairs_lc = unlist(drug_gene_pairs_lc)
vector_drug_gene_pairs_lc
table(vector_drug_gene_pairs_lc)
```


```{r}
#for the next step: We wanna find the drugs that have high cor
K = 0.15

drugs_with_high = apply(cor_drugs_genes_lctargetgenes, 2, function(y){
  length(which(y>K))
}
)
vector_drugsof_drug_gene_pairs_lc = names(which(drugs_with_high>0))
```



```{r}
#BUT!!! ARE THERE ANY NEW DRUGS THAT DID NOT SHOW to be EFFECTIVE as a TREATMENT IN PRISM???
#first lets find o


indices_same_drugs = which(vector_drugsof_drug_gene_pairs_lc %in% names_important_drugs_liver_cancer)
length(vector_drugsof_drug_gene_pairs_lc)
length(indices_same_drugs)
unexpected_drugs_lc = vector_drugsof_drug_gene_pairs_lc[-indices_same_drugs]
unexpected_drugs_lc

#look at the prism scores foer all cancer cell lines 



```

```{r}
#LETS HAVE A LOOK AT THE PRISM SCORES OF THE UNEXPECTED DRUGS 
prims_liver_cancer_unexpected_drugs = prism[liver_cancer_cellline_names, unexpected_drugs_lc]
prims_liver_cancer_unexpected_drugs

```

```{r}
#defining a function, that replaces NAs with the mean value by column

na.mean <- function(dataframe){
  apply(dataframe, 2,function(x){
    meanval = mean(na.omit(x))
    x <- ifelse(is.na(x) == TRUE, meanval, x)
  } )
}
```

```{r}
na.mean(prism[,1:10])
```




```{r}
#kmeans clusterung of drugs that effectively inhibit liver cancer cell line growth
install.packages("zoo")
library(zoo)
```

```{r}
data = highvar(na.aggregate(prism[,names_important_drugs_liver_cancer]), 0.9)
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")

```
```{r}
km.out <- kmeans(data, centers = 2, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```
```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```




+++++++++++LOOKING FOR BIOMARKERS THAT HAVE HIGH CORRELATION BOTH WITH DRUG SENSITIVITY AND GENE KNOCKOUT+++++++++++++++++++++++++++++++++

```{r}
#xxxxxxxxxxxIN THIS CHUNK, WE FIND THE DRUGS AND GENES THAT HAVE HIGH CORRELATIONS WITH THE SAME BIOMARKER 
#STEPS THAT NEED TO BE DONE:
#1 für jedes drug die hohen expressionscorrelationen rausfischen 
#2 für jeden gene knockout die hohen korrelationen rausfischen
#3 vergleichen, ob übereinsgtimmungen zu finden sind 
#falls ja, soll das ausgegeben wereden 
#das alles soll für jeden exp durchgemacht werden 

C = 0.15 #threshold for correlation of drug or genewith exp
result_list <- lapply(rownames(highcor_prism_exp), function(x){
  a = which(highcor_prism_exp[x,] > C)
  a2 = colnames(highcor_prism_exp)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
  return(list(Biomarker = x, correlatingDrug = a2,correlatingGeneknockout = b2))

})
result_list
```


```{r}
C = 0.15 #threshold for correlation of drug or genewith exp

biomarker_correlations <- list()
for (z in 1:length(rownames(cor_bestdrugs_expression))){
  x = rownames(cor_bestdrugs_expression)[z]
  a = which(cor_bestdrugs_expression[x,] > C)
  a2 = colnames(cor_bestdrugs_expression)[a]
  b = which(high_cor_genknockout_exp[x,] > C)
  b2 = rownames(high_cor_genknockout_exp)[b]
  if(length(b2) > 0 & length(a2)){
  result_list2 <- list(correlatingDrug = a2,correlatingGeneknockout = b2)
  biomarker_correlations[[x]] <- result_list2
  }
}
biomarker_correlations
```

```{r}
#z = biomarkers_with_highcor[5]
#z
#biomarker_correlations$"ITGA3"
biomarker_correlations[liver_cancer_biomarkers_with_highcors]
```

```{r}
t = "ABCB1"
biomarker_correlations[[t]]

#biomarker_correlations$ABCB1
```




```{r}
#these are the biomarkers that have correlations both with drugs and gene knockouts
biomarkers_with_highcor = names(biomarker_correlations)
```

```{r}
#now lets see if these biomarkers are biomarkers of liver cancer!
indices_same_biomarkers = which(differentially_expressed_genes_in_liver_cancer %in% biomarkers_with_highcor)
liver_cancer_biomarkers_with_highcors = differentially_expressed_genes_in_liver_cancer[indices_same_biomarkers]
liver_cancer_biomarkers_with_highcors
```
```{r}
#drugs rausfiltern, die hohe correlationen mit den biomarkergenknockouts haben

druggenes_biomarkers_highcor = biomarker_correlations[biomarkers_with_highcor]
df_correlating_drugs = data.frame(matrix(nrow = 2, ncol =0))
rownames(df_correlating_drugs) <- c("gene_knockout", "drug")
for (x in liver_cancer_biomarkers_with_highcors){
  gene_knockout = biomarker_correlations[[x]]$correlatingGeneknockout
  for(y in gene_knockout){
     #name of the genelnolcut
    
    for(z in 1:nrow(df_drug_gene_pairs)){
       name_gene_druggenepair = df_drug_gene_pairs[z, "genknockout"]
      if (z == y){
        out <- c(name_gene_druggenepair, y)
        df_correlating_drugs[,ncol(df_correlating_drugs)+1] <- out
        
         
       }
    }
  }
}
df_correlating_drugs
```


```{r}

correlating_drugs_with_lc_biomarkers <- c()


for (x in 1:length(biomarker_correlations[liver_cancer_biomarkers_with_highcors])) {
  
  Biomarker <- biomarker_correlations[liver_cancer_biomarkers_with_highcors][[x]]
  correlating_drugs_with_lc_biomarkers <- c(correlating_drugs_with_lc_biomarkers, Biomarker$correlatingDrug)
}

correlating_drugs_with_lc_biomarkers

```

```{r}

pheatmap(na.mean(prism[liver_cancer_cellline_names, cleaned_correlating_drugs_with_lc_biomarkers]), cellwidth = 1, cellheight = 10)
```

```{r}
mean(apply(na.mean(prism[liver_cancer_cellline_names, cleaned_correlating_drugs_with_lc_biomarkers]), 2, mean, na.rm = TRUE))
```

```{r}
prcomp(t(na.mean(prism[liver_cancer_cellline_names, cleaned_correlating_drugs_with_lc_biomarkers])))
```


```{r}
drugs_without_indices <- gsub("\\.\\d+$", "", correlating_drugs_with_lc_biomarkers)


cleaned_correlating_drugs_with_lc_biomarkers = unique(drugs_without_indices)
biomarker_drugs = cleaned_correlating_drugs_with_lc_biomarkers[which(correlating_drugs_with_lc_biomarkers %in% colnames(prism.bestofeachdrug))]
#cleaned_correlating_drugs_with_lc_biomarkers
#biomarker_drugs
#is.na(biomarker_drugs)
prism[,cleaned_correlating_drugs_with_lc_biomarkers]
```



```{r}
library(pheatmap)
pheatmap(prism[liver_cancer_cellline_names, drugs_without_indices], cellheight = 10)
```



```{r}
df_drug_gene_pairs[2,2]
#biomarker_correlations[[liver_cancer_biomarkers_with_highcors[5]]]$correlatingGeneknockout
z= "aaB"
f = "aaB"
if (z == f){
  print("wassuo")
}
```

```{r}
#lets see which drugs target the biomarkers
which(prism.treat$target %in% liver_cancer_biomarkers_with_highcors)
all_targets_drugs = rownames(prism.treat)[which(prism.treat$target %in% liver_cancer_biomarkers_with_highcors)]
targets_drugs = all_targets_drugs[which(all_targets_drugs %in% colnames(prism.bestofeachdrug))]
#targets_drugs
effective_drugs_targets = unique(prism.treat[targets_drugs, "target"])
effective_drugs_targets

knockout_effective_drugs_targets = prism.achilles[liver_cancer_cellline_names, c("PTGS2", "OXCT1", "DPP4")]
knockout_effective_drugs_targets
```

```{r}
#how good do these drugs inhibit liver cancer cell growth
prism_lc_biomarker_drugtargets = prism.bestofeachdrug[liver_cancer_cellline_names, targets_drugs]
strong_drug = targets_drugs
strong_drug
prism.treat[strong_drug,]
```

```{r}
library(pheatmap)
#plot(apply(prism.achilles, 2, mean, na.rm = TRUE))
pheatmap(prism_lc_biomarker_drugtargets, cellheight = 10)

```

```{r}
v = which(colnames(prism.achilles) %in% differentially_expressed_genes_in_liver_cancer)
pheatmap(prism.achilles[,v])
```

```{r}
#lc biomarkers and gene knockout sensitivity
hist(apply(prism.achilles[,v], 2, mean))
essential_biomarkers_lc = colnames(prism.achilles)[which((apply(prism.achilles[,v], 2, mean)) < -0.5)]
essential_biomarkers_lc
length(essential_biomarkers_lc)
```






```{r}
##################################find the drug/gene pairs  does not work !!!!!!!!!!!!
Ä = 0.15 #threshold
#df_drug_gene_pairs = data.frame(matrix(ncol = 2, nrow = 0))  
#colnames(df_drug_gene_pairs) <- c("drug", "gene_knockout")
druggens = apply(cor_drugs_genes,c(1,2), function(x){
 if(x > Ä){
   p = colnames(x)
   j = rownames(x)
   drug_gene_pair = c(p,j)
 }
})
druggens
```

```{r}
#>>>>><<<<<<####not sure if it  works with the apply function

#find the drug/gene pairs 
Ä = 0.15 #threshold
df_drug_gene_pairs = data.frame(drug = "character", genknockout = "character", corrval = "numeric")  
#rownames(df_drug_gene_pairs) <- c("drug", "gene_knockout", "correlation value")
for (x in 1:dim(cor_drugs_genes)[1]){
  for (y in 1:dim(cor_drugs_genes)[2]){
     if(cor_drugs_genes[x,y] > Ä){
      p = rownames(cor_drugs_genes)[x]
      j = colnames(cor_drugs_genes)[y]
      k = cor_drugs_genes[x,y]
     # f = prism.treat$moa[p]
      drug_gene_pair = c(j,p,k)
      df_drug_gene_pairs <- rbind(drug_gene_pair, df_drug_gene_pairs)
     # colnames(df_drug_gene_pairs)[ncol(df_drug_gene_pairs)] <- paste0("druggenpair",x)
 }
}
}

df_drug_gene_pairs
```



```{r}
#modes of action of the drugs of the drug gene pairs 
highcor_drugs = df_drug_gene_pairs[1,]
highcor_drugs_vector <- unlist(as.vector(highcor_drugs))
highcor_drugs_vector_unique <- unique(highcor_drugs_vector)
length(highcor_drugs_vector_unique)

#lets see their moa
moa_effective_drugs = prism.treat[highcor_drugs_vector, "moa"]
table(moa_effective_drugs)
```

```{r}
#XXXX robert already did this on a global level#HDAC INHIBITORS SEEM TO BE HIGHLY CORRELATED TO MANY GENE KNOCKOUTS. LETS SEE IF THEY ARE OVEREXPRESSED IN LIVER CANCER.

vector_HDAC = c("HDAC1", "HDAC2", "HDAC3", "HDAC4", "HDAC5", "HDAC6", "HDAC7", "HDAC8", "HDAC9", "HDAC10", "HDAC11")

mean_HDAC_expression = apply(prism.exp[, vector_HDAC],2, mean)
mean_HDAC_expression_lc = apply(prism.exp[liver_cancer_cellline_names, vector_HDAC],2,mean)
df_HDAC_expressions = data.frame(mean_HDAC_expression_lc, mean_HDAC_expression)
df_HDAC_expressions

#t test poosible. do mean values significantly differ? 

```

```{r}
#lets see if there are genes that are highly correlated with the HDAC inhibitor, that are targets of effective liver cancer gene knockouts
highcor_gen = df_drug_gene_pairs[2,]
highcor_gen_vector <- unlist(as.vector(highcor_gen))
highcor_gen_vector_unique <- unique(highcor_gen_vector)
highcor_gen_vector_unique[which(highcor_gen_vector_unique %in% Liver_cancer_target_genes)]
length(which(highcor_gen_vector_unique %in% Liver_cancer_target_genes))
#these genes are all inhibited by HDAC inhibitors. they are likely to be closely associated in the protein network of liver cancer cells. 
```



```{r}
#FOR EACH BIOMARKER, WE HAVE TO SEE IF THERE ARE DRUG/GENE PAIRS IN THE HIGH CORREALTIONS 

#THIS IS WHY WE FIRST HAVE TO CREATE A LIST WITH THE DRUG/GENE PAIRS 
# this is done :)
#lapply(result_list, length)
#result_list
drugs_genes_biomarker <- data.frame(matrix(nrow = 3, ncol=0))
rownames(drugs_genes_biomarker) <- c("biomarker", "drug", "gene")
for (x in biomarkers_with_highcor){
  
    biomarker_drugs_highcor = biomarker_correlations[[x]][1]
    biomarker_geneknockouts_highcor = biomarker_correlations[[x]][2]
    for (y in 1: ncol(df_drug_gene_pairs)){
    #drug_ofdruggenepair = df_drug_gene_pairs[1,y]
   # geneknockout_ofdruggenepair = df_drug_gene_pairs[2,y]
      drug_ofdruggenepair = unlist(as.vector(df_drug_gene_pairs["drug",]))[y]
      geneknockout_ofdruggenepair = unlist(as.vector(df_drug_gene_pairs["gene_knockout",]))[y]
    same_drugs = which(biomarker_drugs_highcor %in% drug_ofdruggenepair)
    same_geneknockouts = which(biomarker_geneknockouts_highcor %in% geneknockout_ofdruggenepair)
    
    d = length(same_drugs)
    g = length(same_geneknockouts)
    
   
    
    if (d>0 & g>0){
      output = c(biomarkers_with_highcor[x], drug_ofdruggenepair, geneknockout_ofdruggenepair)
      drugs_genes_biomarker[,ncol(drugs_genes_biomarker)+1] <- output
    }
    
    
    
    
}
}
```


```{r}
#lastly i want to see which  drugs have correlations with multiple gene knockouts
#>>>>><<<<<<####not sure if it  works with the apply function

#find the drug/gene pairs 
Ä = 0.15 #threshold
list_drug_gene_correlations = list()
for (x in colnames(cor_drugs_genes)){
 indices_highcor_geneknockouts = which(cor_drugs_genes[,x]>Ä)
 output = cor_drugs_genes[,x][indices_highcor_geneknockouts]
list_drug_gene_correlations[[x]] <- output
}


list_drug_gene_correlations

```


```{r}
number_of_correlations_drug = unlist(lapply(list_drug_gene_correlations,length))
hist(number_of_correlations_drug, breaks = 200)
summary(number_of_correlations_drug)
length(which(number_of_correlations_drug == 0))
length(colnames(cor_drugs_genes))
```

```{r}
#biomarker and geneknockouts 


```






##########################CLUSTERING########################

```{r}
library(cluster)
prism.0.9 = highvar(prism, 0.9)
prism.0.9.lc = prism.0.9

kmeans(na.omit(prism[,1:100]), centers = 3, nstart = 20)
```







```{r}
summary(highcor_prism_exp)
```





############cluster analysis#########################

WE WANT TO PERFORM A CLUSTER ANALYSIS

```{r}
install.packages("factoextra")
library(factoextra)
```


```{r}
#DATACLEANING
data_prism.achilles = na.omit(prism.achilles)
data_prism.exp = na.omit(prism.exp)
data_prism.cnv = na.omit(prism.cnv)
```

```{r}
data_lc <- data_prism.achilles[,Liver_cancer_target_genes]
data_lc_target_genes_prism.achilles_highvar = highvar(data_lc_target_genes_prism.achilles_highvar)
```


```{r}
#data = t(highvar(data_prism.achilles, 0.95))

elbow <- function(data){
#scale 
data_scaled = scale(data)
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
}
elbow(data)
```

```{r}
km.out <- kmeans(data, centers = 3, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```

```{r}
cluster1 = which(km.out$cluster == 1)
cluster2 = which(km.out$cluster == 2)
cluster3 = which(km.out$cluster == 3)
names_cluster1 = names(cluster1)
names_cluster2 = names(cluster2)
names_cluster3 = names(cluster3)
```


```{r}
genes_cluster <- list(names_cluster1, names_cluster2, names_cluster3)
save(genes_cluster, file = "genes_cluster.RData")
```

```{r}
mean(apply(prism.achilles[,names_cluster1],2, mean, na.rm = TRUE))
mean(apply(prism.achilles[,names_cluster2],2, mean, na.rm = TRUE))
mean(apply(prism.achilles[,names_cluster3],2, mean, na.rm = TRUE))
```

#these genes are clustered by their importance for cell growth
#t test if they significantly differ from each orher could make sense


```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```
```{r}
lc_gene
```


+++++++++now with prism cnv ++++++++++++

```{r}

data = t(highvar(data_prism.cnv, 0.95))
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
```

```{r}
km.out <- kmeans(data, centers = 4, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```
```{r}
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
```


+++++++++ kmeans EXP +++++++++++++++++++++++++++++


```{r}

data = (highvar(data_prism.exp, 0.9))
#scale 
data_scaled = scale(data)

#
```

```{r}
#find out how many clusters are needed
fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(subtitle = "elbow method")
```

```{r}
km.out <- kmeans(data, centers = 4, nstart = 100)
km.clusters <- km.out$cluster
fviz_silhouette(silhouette(km.clusters, dist(data)))
km.out
```

###########prism clustering################


```{r}
elbow(na.aggregate(highvar((prism), 0.9)))
```
```{r}
data = na.aggregate(highvar(prism, 0.9))
km.out <- kmeans(data, centers = 3, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```


```{r}
elbow(t(highvar(na.aggregate(prism), 0.9)))
```

```{r}
data = t(highvar(na.aggregate(prism), 0.9))
km.out <- kmeans(data, centers = 3, nstart = 100)
km.clusters <- km.out$cluster
fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
```

 I want to cluster the prism scores by mode of actrion of the drugs######


```{r}

dataset1 = t(prism.treat)
dataset2 = prism
order_actual_dataset1 = colnames(dataset1)
order_target_dataset1 = colnames(dataset2)
new_dataset1= dataset1[,match(order_target_dataset1, order_actual_dataset1,)]
new_dataset1
```

```{r}
modes_of_action = unique(prism.treat$moa)
modes_of_action_all
copy_prism = prism
colnames(copy_prism) <- modes_of_action_all
```


```{r}
#kmeans clustering of genes with exp, cnv, achilles


same_cols = colnames(prism.achilles)[which(colnames(prism.achilles) %in% colnames(prism.exp))]
very_same_cols = same_cols[which(same_cols %in% colnames(prism.cnv))]

dataframe1 = prism.achilles[, very_same_cols]
dataframe2 = prism.exp[, very_same_cols]
dataframe3 = prism.cnv[, very_same_cols]

order_target_colnames = colnames(dataframe1)
order_dataset2 = colnames(dataframe2)
order_dataset3 = colnames(dataframe3)
new_dataframe2 = dataframe2[,match(order_target_colnames, order_dataset2)]
new_dataframe3 = dataframe3[,match(order_target_colnames, order_dataset3)]

achilles.mean = apply(dataframe1, 2, mean, na.rm = TRUE)
exp.mean = apply(new_dataframe2, 2, mean, na.rm = TRUE)
cnv.mean = apply(new_dataframe3, 2, mean, na.rm = TRUE)

df_exp_cnv_achilles = data.frame(achilles.mean, exp.mean, cnv.mean)
df_exp_cnv_achilles

```


```{r}
#find out how many clusters are needed
elbow(df_exp_cnv_achilles)
```

```{r}
#library(cluster)
data = df_exp_cnv_achilles
km.out <- kmeans(data, centers = 4, nstart = 100)
#km.clusters <- km.out$cluster
#fviz_cluster(list(data = data, cluster = km.clusters), geom = "points")
km.out
#fviz_silhouette(silhouette(km.out$cluster, dist(data)))
```
```{r}
for(i in 1:4){
  fro = rownames(df_exp_cnv_achilles)[which(km.out$cluster == i)]
  trg = which(fro %in% prism.treat$target)
  drugs = rownames(prism.treat)[trg]
  print(mean(apply(prism[,drugs], 2, mean, na.rm = TRUE)))
}
```
```{r}
  fro = rownames(df_exp_cnv_achilles)[which(km.out$cluster == 3)]
trg = which(fro %in% prism.treat$target)
  drugs = rownames(prism.treat)[trg]
  print(mean(apply(prism[,drugs], 2, mean, na.rm = TRUE)))
```



```{r}
for(i in 1:4){
  fro = rownames(df_exp_cnv_achilles)[which(km.out$cluster == i)]
  
  print(mean(apply(prism.achilles[,fro], 2, mean, na.rm = TRUE)))
}
```

```{r}
print(differentially_expressed_genes_in_liver_cancer)
```



```{r}
#testing for lc_biomarkers

for(i in 1:4){
  fro = rownames(df_exp_cnv_achilles)[which(km.out$cluster == i)]
  trg = which(fro %in% differentially_expressed_genes_in_liver_cancer)
  genes = fro[trg]
  if(length(genes) == 0){
    print("no genes")
  }
  print(genes)
}
```
```{r}
lc_genes_1 = differentially_expressed_genes_in_liver_cancer[which(differentially_expressed_genes_in_liver_cancer %in% rownames(df_exp_cnv_achilles)[km.out$cluster == 1])]
lc_genes_2 = differentially_expressed_genes_in_liver_cancer[which(differentially_expressed_genes_in_liver_cancer %in% rownames(df_exp_cnv_achilles)[km.out$cluster == 2])]
lc_genes_3 = differentially_expressed_genes_in_liver_cancer[which(differentially_expressed_genes_in_liver_cancer %in% rownames(df_exp_cnv_achilles)[km.out$cluster == 3])]
lc_genes_4 = differentially_expressed_genes_in_liver_cancer[which(differentially_expressed_genes_in_liver_cancer %in% rownames(df_exp_cnv_achilles)[km.out$cluster == 4])]
length(lc_genes_1)
length(lc_genes_2)
length(lc_genes_3)
length(lc_genes_4)

lc_genes_1
#lc_genes_2
lc_genes_3
#
lc_genes_4


```

```{r}
lc_tets = differentially_expressed_genes_in_liver_cancer[which(differentially_expressed_genes_in_liver_cancer %in% rownames(df_exp_cnv_achilles)[km.out$cluster == 1])]
lc_tets

lc_genes_1 = rownames(df_exp_cnv_achilles)[which(rownames(df_exp_cnv_achilles)[which(km.out$cluster == 1)] %in% differentially_expressed_genes_in_liver_cancer)]
lc_genes_2 = rownames(df_exp_cnv_achilles)[which(rownames(df_exp_cnv_achilles)[which(km.out$cluster == 2)] %in% differentially_expressed_genes_in_liver_cancer)]
lc_genes_3 = rownames(df_exp_cnv_achilles)[which(rownames(df_exp_cnv_achilles)[which(km.out$cluster == 3)] %in% differentially_expressed_genes_in_liver_cancer)]
lc_genes_4 = rownames(df_exp_cnv_achilles)[which(rownames(df_exp_cnv_achilles)[which(km.out$cluster == 4)] %in% differentially_expressed_genes_in_liver_cancer)]
```




```{r}
#see if data ist normally distributed have to use wilcox as im not sure if data is normally distriburted
#shapiro.test(df_exp_cnv_achilles[lc_genes_4, 2])
for (y in 1:3){
print(wilcox.test(df_exp_cnv_achilles[lc_genes_1, y], df_exp_cnv_achilles[c(lc_genes_2, lc_genes_3, lc_genes_4), y]))
  print(wilcox.test(df_exp_cnv_achilles[lc_genes_2, y], df_exp_cnv_achilles[c(lc_genes_1, lc_genes_3, lc_genes_4), y]))
print(wilcox.test(df_exp_cnv_achilles[lc_genes_3, y], df_exp_cnv_achilles[c(lc_genes_2, lc_genes_1, lc_genes_4), y]))
print(wilcox.test(df_exp_cnv_achilles[lc_genes_4, y], df_exp_cnv_achilles[c(lc_genes_2, lc_genes_3, lc_genes_1), y]))

}
```


ENTRY TEST AREA 51 - WHAT HAPPENS HERE STAYS HERE
```{r}


copy_dataset1 = prism_venetoclax
dataset2 = prism.exp
order_actual_dataset1 = rownames(copy_dataset1)
order_target_dataset1 = rownames(dataset2)
new_dataset1= copy_dataset1[match(order_target_dataset1, order_target_dataset1),]
y = dataset2[,"BCL2"]
#correlation_test <- function(dataset1, dataset3){

cor_dataset1_dataset2 <- apply(new_dataset1, 2, function(x){ #first loop iterates through all columns of prism
    y = dataset2[,"BCL2"]
  #second loop iterates through all columns of prsim.achilles for each gene
     #fist remove all NAs
    x.remove = which(is.na(x)) #detecting the postitions of the drugs scores with missing values
    y.remove = which(is.na(y))#detecting the postitions of the gene knockout scores with missing values
    y_cleaned = y[c(-y.remove, -x.remove)] #vector with CCls removed that had NA eitherr in y or x
    x_cleaned = x[c(-y.remove, -x.remove)]#vector with CCls removed that had NA eitherr in y or x
  cor(y_cleaned,x_cleaned, method = "spearman")
  
   
}
)
cor_dataset1_dataset2
```

```{r} 
#trying to remodel resuts from paper
Venetoclax_drugs = rownames(prism.treat)[which(prism.treat$name == "venetoclax")]
Venetoclax_drugs
prism_venetoclax = prism[,Venetoclax_drugs]

prism.exp_BCL2 <- prism.exp[,"BCL2"]

cors = correlation_test(prism_venetoclax,prism.exp_BCL2)
cors
```


```{r}
x = rownames(highcor_prism_exp)[5]
a = which(highcor_prism_exp[x,] > 0)
 # a2 = highcor_prism_exp[x, a]
  a2 = colnames(highcor_prism_exp)[a]
  a2
  x
  a
  highcor_prism_exp[x,]
  length(highcor_prism_exp[x,])
```

```{r}
#I WANT TO GET ALL THE DRUG GENE PAIRS IN A MATRIX 

list_druggenepairs <- apply(cor_drugs_genes,c(1,2),function(x){
  if(x > T){
    return(list(colnames(x), rownames(x)))
  }
})
list_druggenepairs
```





```{r}

#removing all cell lines with missung values for one specific row
#sum(is.na(prism[,1]))
i.remove = which(is.na(prism[,1]))
#i.remove
new.prism1 = prism[-i.remove,1]
new.prism1

#remove CCLs with missing value for every row 
i.remove = which(is.na(prism[,i]))
#i.remove
new.prism = prism[-i.remove,i]
new.prism

```


```{r}
pheatmap(cor_drugs_genes)
```


```{r}
x <- prism[,1]
y <- prism[,2]
#berechnen der correlation
cor(x,y, method = "spearman")
```
```{r}
#just checking if all CCls of the achilles dataset are represented in the prism dataset
matching.CLL = rownames(prism) %in% rownames(prism.achilles)
sum(matching.CLL)
```

```{r}
length(apply(prism, 1, mean))
```

```{r}
#test area
h1 = c(1,2,3,2,3,NA)
h2 = c(2,NA,2,4,3,5)
h3 = c(2,4,NA,3,5,4)
h4 = c(2,2,3,2,4,5)

H <- data.frame(h1,h2,h3,h4)
H

cor(H, method = "spearman")
```
```{r}
#just some tests

x= prism[,2]
y= prism[,80]


    x.remove = which(is.na(x))
    x.remove
    y.remove = which(is.na(y))
    y.remove
    
sum(is.na(x))
sum(is.na(y))
    y.new.prism = y[c(-y.remove, -x.remove)]#y is a vector of gene knockout scores without NAs for all CCLs
    y.new.prism
  x.new.prism = x[c(-y.remove, -x.remove)]
  x.new.prism
  cor(x.new.prism,y.new.prism, method = "spearman")
```


```{r}
```
```{r}
#testing if the "2" is reoved twice and NO IT IS NOT :)
v1 <- c(1,2,3,4,5,6,7,8,9,10)
rmv1 <- c(1,2)
rmv2 <- c(2,3)

v1[c(-rmv1, -rmv2)]
```
```{r}
#SPIELPLATZ
sum(rownames(prism.achilles) %in% rownames(prism.exp))
rm <- which(rownames(prism.achilles) %in% rownames(prism.exp))
rownames(prism.achilles[rm,])


```

```{r}
#SPIELPLATZ
sum(is.na(prism.cnv))
sum(rownames(prism.achilles) %in% rownames(prism.cnv))
sum(rownames(prism) %in% rownames(prism.cnv))

sum(rownames(prism.cnv) %in% rownames(prism.achilles))
sum(rownames(prism.cnv) %in% rownames(prism))
```

```{r}
prism.var = apply(prism, 2, var)
q90 = quantile(prism.var, probs = 0.9)
topvari = which(prism.var > q90)

```


```{r}
z = 1:3
remo = which(is.na(prism[z,]))
cleanedpri = prism[z,][-remo]
apply(cleanedpri,2, function(x){
  if(x>0.5){
    print(x)}})

```
```{r}
#i want to reduce the dimensionslaity of the correlaion matrix to those columns that contain high correlationvalues, i just need the names of columns(drugs) with high correlation 

#first create a vektor with the sum the vlues above a threshold

threshold.machine <- function(x){
  which
  
}


apply(cor_drugs_genes, 2, )
```



```{r}
fef = c(1,2,3,4,5,6,7,8,9)
fef2= c(1,2,3,4,5,6,7,8,9)
fef3= c(4,5,4,3,5,6,45,4,4)
fef4 = c(3,4,3,43,43,4,2,4,4)
fef5 = c(5,67,4,7,8,5,3,5,8)

feframe <- data.frame(fef, fef2, fef3, fef4, fef5)
fuf <- apply(feframe, 2, function(x){
  sum(x > 5)})
fuf
#hist(fuf, breaks = 30)
sum(fuf>3)
fef3>3

```

```{r}
#CODETESTING
high_cor_drugs_genes = cor_drugs_genes[, highly_correlated_drugs] #hist(apply(prism.exp, 2, mean), breaks= 200)

```

```{r}
#code testing 
dim(highvar(prism.exp, 0.1))
```


```{r}
#JUST PLAYING 
A = c(1,2,3,4,5,6,7,8)
B = c(2,3)
C = c(4,5,3,4,5,4,43,4)
G = A[which( A %in% B)]
G
H = which(B %in% A)
H
```

```{r}
testlist <- list(x1= list(A,fef3), x2 = B, x3 = C)
#testlist <- list(x1= A, x2 = B, x3 = C)

#testlist
#lapply(testlist, mean)

testlist[c(1,2)]
```



```{r}
lapply(fef, function(x){
  x+1
})
```
```{r}
#LEARNING ABOUT LISTS
Name = "learn"
mylul <- list(Name= Name, vector7 = A, dat7 = feframe)
#mylul
mylul[c(1,2)]

```

```{r}
# Daten einlesen





data <- na.omit(highvar(prism.exp, 0.9))
  #read.csv("prism")

# K-Means-Clustering durchführen
k <- 6  # Anzahl der Cluster
set.seed(123)  # Festlegen des Zufallssaat für Reproduzierbarkeit
kmeans_model <- kmeans(data, centers = k)

# Ergebnisse anzeigen
print(kmeans_model)

# Visualisierung der Cluster
library(ggplot2)
ggplot(data, aes(x = prism.exp$colnames(data)[1], y = prism.exp$colnames(data)[2] , color = as.factor(kmeans_model$cluster))) +
  geom_point() +
  labs(color = "Cluster") +
  theme_minimal()
```



```{r}
df = prism[1:10, 1:10]
colnames(df) <- c(1,2,3,4,5,6,7,8,9,10)
colnames(df)
```
```{r}
testlist[[1]]

